{% extends "dashboard/base.html" %}
{% load humanize %}

{% block title %}Production vs Plant Demand{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Production vs Plant Demand</h1>
    <div>
        <a href="{% url 'add-production' %}" class="btn btn-primary btn-sm me-2">+ Add Production</a>
        <a href="{% url 'add-plantdemand' %}" class="btn btn-danger btn-sm">+ Add Plant Demand</a>
    </div>
</div>

<div class="row text-center mb-3">
    <div class="col-md-3"><div class="card shadow-sm p-2"><small>Total Ore (t)</small><h4 id="totalOre">{{ total_production|intcomma }}</h4></div></div>
    <div class="col-md-3"><div class="card shadow-sm p-2"><small>Total Demand (t)</small><h4 id="totalDemand">{{ total_demand|intcomma }}</h4></div></div>
</div>

<div class="mb-2 d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
        <label class="small text-muted">Filter Date:</label>
        <input type="date" class="form-control form-control-sm" id="startDate" style="width: auto;">
        <input type="date" class="form-control form-control-sm" id="endDate" style="width: auto;">
        <button class="btn btn-secondary btn-sm" onclick="applyDateFilter()">Apply</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="resetFilter()">Reset</button>
    </div>
    <div>
        <button class="btn btn-sm btn-outline-success" onclick="exportCSV()"><i class="fas fa-file-csv"></i> CSV</button>
        <button class="btn btn-sm btn-outline-danger" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-body">
        <canvas id="prodDemandChart" height="80"></canvas>
    </div>
</div>

<div class="mt-4">
    <h5>Data Log (Chart Data)</h5>
    <div class="table-responsive">
        <table class="table table-sm table-hover table-bordered" id="varianceTable">
            <thead class="table-dark">
                <tr>
                    <th>Date</th>
                    <th class="text-end">Ore (t)</th>
                    <th class="text-end">Waste (t)</th>
                    <th class="text-end">Total Production (t)</th>
                    <th class="text-end">Demand (t)</th>
                    <th class="text-end">Variance (t)</th>
                </tr>
            </thead>
            <tbody id="varianceTableBody"></tbody>
        </table>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2 bg-danger text-white"><h6 class="m-0 fw-bold">Recent Plant Demand</h6></div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    {% for item in recent_demand %}
                    <tr>
                        <td>{{ item.timestamp|date:"d M Y" }}</td>
                        <td class="text-end fw-bold">{{ item.required_tonnage|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr><td class="text-muted text-center">No Data</td></tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow mb-4">
            <div class="card-header py-2 bg-primary text-white"><h6 class="m-0 fw-bold">Recent Production</h6></div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    {% for item in recent_production %}
                    <tr>
                        <td>{{ item.timestamp|date:"d M Y" }}</td>
                        <td>{{ item.material_type|title }}</td>
                        <td class="text-end fw-bold">{{ item.tonnage|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr><td class="text-muted text-center">No Data</td></tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let originalData = [];
let filteredData = [];

// 1. Fetch Data
async function initialLoad() {
    try {
        const response = await fetch('', { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        processData(data);
    } catch(err) {
        console.error("Error fetching chart data:", err);
    }
}

// 2. Process Data for Chart
function processData(data) {
    const prodData = data.production;
    const demandData = data.demand;
    const combined = {};

    // Helper to init date obj
    const getObj = (d) => {
        const dateStr = d.slice(0,10);
        if(!combined[dateStr]) combined[dateStr] = { date: new Date(dateStr), label: dateStr, ore:0, waste:0, demand:0 };
        return combined[dateStr];
    }

    // Process Production
    prodData.forEach(p => {
        const obj = getObj(p.timestamp);
        if(p.material_type === 'ore') obj.ore += Number(p.tonnage);
        else obj.waste += Number(p.tonnage);
    });

    // Process Demand
    demandData.forEach(d => {
        const obj = getObj(d.timestamp);
        obj.demand += Number(d.required_tonnage);
    });

    // Flatten to Array
    originalData = Object.values(combined).map(d => {
        d.production = d.ore + d.waste;
        d.variance = d.production - d.demand;
        return d;
    }).sort((a,b) => a.date - b.date);

    applyDateFilter(); // Render
}

// 3. Render
function renderDashboard(data) {
    // Chart
    const ctx = document.getElementById('prodDemandChart').getContext('2d');
    if(window.prodChart) window.prodChart.destroy();

    window.prodChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.label),
            datasets: [
                { label: 'Production', data: data.map(d=>d.production), borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.1)', fill: true },
                { label: 'Demand', data: data.map(d=>d.demand), borderColor: '#dc3545', borderDash: [5,5] }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // Log Table
    const tbody = document.getElementById('varianceTableBody');
    tbody.innerHTML = '';
    data.forEach(d => {
        const row = `<tr>
            <td>${d.label}</td>
            <td class="text-end">${d.ore.toLocaleString()}</td>
            <td class="text-end">${d.waste.toLocaleString()}</td>
            <td class="text-end fw-bold">${d.production.toLocaleString()}</td>
            <td class="text-end">${d.demand.toLocaleString()}</td>
            <td class="text-end fw-bold ${d.variance >= 0 ? 'text-success' : 'text-danger'}">${d.variance.toLocaleString()}</td>
        </tr>`;
        tbody.innerHTML += row;
    });
}

function applyDateFilter() {
    let result = [...originalData];
    const startVal = document.getElementById('startDate').value;
    const endVal = document.getElementById('endDate').value;
    if(startVal) result = result.filter(d => d.date >= new Date(startVal));
    if(endVal) result = result.filter(d => d.date <= new Date(endVal));
    
    filteredData = result;
    renderDashboard(filteredData);
}

function resetFilter() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    applyDateFilter();
}

function exportCSV() {
    if(!filteredData.length) return alert("No data");
    let csv = "Date,Ore,Waste,Production,Demand,Variance\n";
    filteredData.forEach(d => {
        csv += `${d.label},${d.ore},${d.waste},${d.production},${d.demand},${d.variance}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'report.csv'; a.click();
}

function exportPDF() {
    if(!filteredData.length) return alert("No data");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Production Report", 14, 15);
    doc.autoTable({
        head: [['Date', 'Ore', 'Waste', 'Prod', 'Demand', 'Var']],
        body: filteredData.map(d => [d.label, d.ore, d.waste, d.production, d.demand, d.variance]),
        startY: 20
    });
    doc.save('report.pdf');
}

initialLoad();
</script>
{% endblock %}