{% extends 'dashboard/base.html' %}
{% block title %}Ore Grade & Tonnage{% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<h2 class="bg-dark text-light p-3 rounded shadow">â›ï¸ Ore Grade & Tonnage Over Time</h2>

<div class="mb-3 d-flex gap-2">
    <a href="{% url 'add-oresample' %}" class="btn btn-success">â• Add Ore Sample</a>
    <button onclick="exportChartToPDF()" class="btn btn-outline-danger">ğŸ§¾ Export to PDF</button>
    <button id="refreshChartBtn" class="btn btn-outline-primary ms-auto">ğŸ”„ Refresh Chart</button>
</div>

<div class="card shadow p-3">
    <div id="chartContainer" style="background-color: white;">
        <canvas id="oreGradeTonnageChart" width="900" height="400"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

<script>
let oreChart;

async function fetchOreAndProductionData() {
    try {
        const response = await fetch('/api/oresamples/');
        const oreData = await response.json();

        if (!oreData.length) {
            console.warn("No ore data found.");
            return;
        }

        const phases = [...new Set(oreData.map(item => item.mine_phase.name))];
        const datasets = [];

        // Actual Grade per Phase
        phases.forEach(phase => {
            datasets.push({
                label: `${phase} Actual Grade`,
                data: oreData
                    .filter(item => item.mine_phase.name === phase)
                    .map(item => ({ x: item.timestamp, y: item.actual_grade_g_t })),
                type: 'line',
                yAxisID: 'yGrade',
                borderColor: randomColor(),
                fill: false,
                tension: 0.1
            });
        });

        // Expected Grade
        datasets.push({
            label: 'Expected Grade',
            data: oreData.map(item => ({ x: item.timestamp, y: item.expected_grade })),
            type: 'line',
            yAxisID: 'yGrade',
            borderColor: 'rgba(0, 255, 0, 0.8)',
            borderDash: [5, 5],
            fill: false,
            tension: 0.1
        });

        // Actual Tonnage (bright line)
        datasets.push({
            label: 'Actual Tonnage',
            data: oreData.map(item => ({ x: item.timestamp, y: item.actual_tonnage })),
            type: 'line',
            yAxisID: 'yTonnage',
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderWidth: 3,
            pointRadius: 4,
            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
            tension: 0.3,
            fill: false
        });

        // Expected Tonnage
        datasets.push({
            label: 'Expected Tonnage',
            data: oreData.map(item => ({ x: item.timestamp, y: item.expected_tonnage })),
            type: 'line',
            yAxisID: 'yTonnage',
            borderColor: 'rgba(128, 0, 128, 0.8)',
            borderDash: [6, 3],
            fill: false,
            tension: 0.1
        });

        if (oreChart) oreChart.destroy();

        const ctx = document.getElementById('oreGradeTonnageChart').getContext('2d');
        oreChart = new Chart(ctx, {
            data: { datasets },
            options: {
                responsive: true,
                parsing: { xAxisKey: 'x', yAxisKey: 'y' },
                plugins: {
                    title: { display: true, text: 'Ore Grade & Tonnage Over Time' },
                    tooltip: { mode: 'index', intersect: false },
                    legend: { position: 'bottom' }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day' },
                        title: { display: true, text: 'Date' }
                    },
                    yGrade: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Grade (g/t)' },
                        beginAtZero: true
                    },
                    yTonnage: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Tonnage (t)' },
                        beginAtZero: true,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

    } catch (error) {
        console.error("Error loading chart data:", error);
    }
}

function randomColor() {
    return '#' + Math.floor(Math.random() * 16777215).toString(16);
}

// --- New Function: Export Chart to PDF ---
function exportChartToPDF() {
    const { jsPDF } = window.jspdf;
    const canvas = document.getElementById('oreGradeTonnageChart');
    
    // Create image from canvas
    const chartImage = canvas.toDataURL('image/png', 1.0);
    
    // Create PDF (Landscape orientation usually fits charts better)
    const pdf = new jsPDF('landscape');
    
    pdf.setFontSize(20);
    pdf.text("Ore Grade & Tonnage Report", 15, 15);
    
    pdf.setFontSize(10);
    pdf.text(`Generated on: ${new Date().toLocaleString()}`, 15, 22);

    // Add Image (x, y, width, height)
    // Adjust dimensions as needed for your specific layout
    pdf.addImage(chartImage, 'PNG', 10, 30, 280, 150);
    
    pdf.save('Ore_Grade_Tonnage_Report.pdf');
}

document.getElementById('refreshChartBtn').addEventListener('click', () => {
    fetchOreAndProductionData();
    const msg = document.createElement('div');
    msg.classList.add('alert-inline', 'bg-info', 'text-white', 'position-fixed', 'top-0', 'end-0', 'm-3', 'p-2', 'rounded', 'shadow');
    msg.textContent = 'ğŸ”„ Chart refreshed';
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 2000);
});

fetchOreAndProductionData();
</script>
{% endblock %}