{% extends 'dashboard/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}ðŸ“¦ Stockpile Forecast{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-light bg-dark p-3 rounded shadow d-inline-block">
                <i class="fas fa-cubes me-2"></i>Stockpile Forecast
            </h2>
            <div class="text-muted mt-1 ml-1">Scenario: {{ scenario.name }}</div>
        </div>
        
        <div class="d-flex gap-2">
            <button class="btn btn-primary shadow" data-bs-toggle="modal" data-bs-target="#addActualModal">
                <i class="fas fa-edit mr-2"></i> Add Actuals
            </button>
        </div>
    </div>

    <div class="card shadow mb-4 border-0">
        <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
            <span><i class="fas fa-chart-bar me-2"></i> Cumulative Inventory Status</span>
            <span class="badge bg-primary">Current / End of Plan</span>
        </div>
        <div class="card-body bg-dark">
            <div style="height: 400px;"> 
                <canvas id="stockpileChart"></canvas>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4 border-0">
        <div class="card-header bg-dark text-white fw-bold">
            <i class="fas fa-list me-2"></i> Detailed Period Breakdown
        </div>
        <div class="card-body bg-white p-0">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-striped table-hover mb-0">
                    <thead class="bg-light text-dark" style="position: sticky; top: 0; z-index: 1;">
                        <tr>
                            <th>Period / Stockpile Type</th>
                            <th class="text-end">Actual (Survey)</th>
                            <th class="text-end">Projected (Cumulative)</th>
                            <th class="text-end">Variance</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in detailed_data %}
                        <tr>
                            <td class="fw-bold" style="color: {{ row.color }}">{{ row.name }}</td>
                            <td class="text-end">{{ row.actual|floatformat:0|intcomma }}</td>
                            <td class="text-end text-muted">{{ row.projected|floatformat:0|intcomma }}</td>
                            <td class="text-end fw-bold" style="color: {% if row.variance >= 0 %}#198754{% else %}#dc3545{% endif %};">
                                {{ row.variance|floatformat:0|intcomma }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-4 text-muted">No schedule data available.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addActualModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Record Actual Stockpile Survey</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label class="font-weight-bold">Select Period</label>
                        <select name="period" class="form-control">
                            {% for p in periods %}
                            <option value="{{ p }}">Period {{ p }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="text-success font-weight-bold">High Grade</h6>
                            <input type="number" step="0.1" name="hg_tonnage" class="form-control mb-2" placeholder="Tonnes">
                            <input type="number" step="0.01" name="hg_grade" class="form-control" placeholder="Grade (g/t)">
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-warning font-weight-bold" style="color:#d39e00!important">Medium Grade</h6>
                            <input type="number" step="0.1" name="mg_tonnage" class="form-control mb-2" placeholder="Tonnes">
                            <input type="number" step="0.01" name="mg_grade" class="form-control" placeholder="Grade (g/t)">
                        </div>
                        <div class="col-md-4">
                            <h6 class="text-danger font-weight-bold">Low Grade</h6>
                            <input type="number" step="0.1" name="lg_tonnage" class="form-control mb-2" placeholder="Tonnes">
                            <input type="number" step="0.01" name="lg_grade" class="form-control" placeholder="Grade (g/t)">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Actuals</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// --- CHART LOGIC (Simplified: No Filter needed) ---
document.addEventListener('DOMContentLoaded', () => {
    const ctx = document.getElementById('stockpileChart').getContext('2d');
    
    // Data passed directly from View
    const chartData = [
        {% for item in chart_data %}
        {
            name: "{{ item.name }}",
            projected: {{ item.projected }},
            actual: {{ item.actual }},
            color: "{{ item.color }}",
            border: "{{ item.border }}"
        },
        {% endfor %}
    ];

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.map(d => d.name),
            datasets: [
                {
                    label: 'Latest Actual (Survey)',
                    data: chartData.map(d => d.actual),
                    backgroundColor: chartData.map(d => d.color),
                    borderColor: chartData.map(d => d.border),
                    borderWidth: 1
                },
                {
                    label: 'Total Projected (Plan)',
                    data: chartData.map(d => d.projected),
                    type: 'line',
                    borderColor: '#ffffff',
                    borderDash: [5, 5],
                    pointBackgroundColor: '#ffffff',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#ffffff' } } },
            scales: {
                y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: '#444' } },
                x: { ticks: { color: '#fff' }, grid: { display: false } }
            }
        }
    });
});
</script>
{% endblock %}