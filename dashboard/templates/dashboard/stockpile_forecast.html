{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}ðŸ“¦ Stockpile Forecast{% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<div class="container-fluid mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="text-light bg-dark p-3 rounded shadow">ðŸ“¦ Stockpile Forecast</h2>
        <div class="d-flex gap-2">
            <button onclick="exportStockpileCSV()" class="btn btn-outline-success">
                <i class="fas fa-file-csv"></i> Export CSV
            </button>
            <button onclick="exportStockpilePDF()" class="btn btn-outline-danger">
                <i class="fas fa-file-pdf"></i> Export PDF
            </button>
            <a href="{% url 'add-stockpile' %}" class="btn btn-success">âž• Add Stockpile</a>
        </div>
    </div>

    <p class="text-light mb-4">
        Monitor current vs projected stockpile levels and ore grades. Variances highlight overstock or understock situations.
    </p>

    <div class="card bg-dark text-light p-3 shadow mb-4">
        <h5 class="mb-3">Stockpile Forecast Over Time</h5>
        <div id="chartContainer" style="position: relative; height: 400px; background-color: #212529;"> 
            <canvas id="stockpileChart"></canvas>
        </div>
    </div>

    <div class="card bg-dark text-light p-3 shadow mb-4">
        <h5 class="mb-3">Stockpile Summary</h5>
        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover" id="stockpileTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Actual Tonnage (t)</th>
                        <th>Projected Tonnage (t)</th>
                        <th>Ore Grade (%)</th>
                        <th>Variance (t)</th>
                        <th>Variance (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in stockpile_data %}
                    <tr>
                        <td>{{ s.name }}</td>
                        <td>{{ s.current_tonnage|floatformat:1 }}</td>
                        <td>{{ s.projected_tonnage|floatformat:1 }}</td>
                        <td>{{ s.grade|default:"N/A" }}</td>
                        <td style="color: {% if s.variance >= 0 %}#28c76f{% else %}#ea5455{% endif %};">
                            {{ s.variance|floatformat:1 }}
                        </td>
                        <td style="color: {% if s.variance_percent >= 0 %}#28c76f{% else %}#ea5455{% endif %};">
                            {{ s.variance_percent|floatformat:1 }}%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const ctx = document.getElementById('stockpileChart').getContext('2d');

    const stockpileNames = {{ stockpile_names_json|safe }};
    const actualTonnage = {{ actual_tonnage_json|safe }};
    const projectedTonnage = {{ projected_tonnage_json|safe }};

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: stockpileNames,
            datasets: [
                {
                    label: 'Actual Tonnage',
                    data: actualTonnage,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Projected Tonnage',
                    data: projectedTonnage,
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Stockpile Forecast vs Actual',
                    color: '#ffffff'
                },
                legend: {
                    labels: { color: '#ffffff' }
                },
                tooltip: {
                    callbacks: {
                        afterBody: function(context) {
                            const idx = context[0].dataIndex;
                            const variance = actualTonnage[idx] - projectedTonnage[idx];
                            const variancePct = projectedTonnage[idx] ? ((variance / projectedTonnage[idx]) * 100).toFixed(1) : 0;
                            return `Variance: ${variance.toFixed(1)} t (${variancePct}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Tonnage (t)', color: '#ffffff' },
                    grid: { color: '#444' },
                    ticks: { color: '#fff' }
                },
                x: {
                    title: { display: true, text: 'Stockpile', color: '#ffffff' },
                    grid: { color: '#444' },
                    ticks: { color: '#fff' }
                }
            }
        }
    });
});

// --- CSV Export Function ---
function exportStockpileCSV() {
    const table = document.getElementById("stockpileTable");
    let rows = [];
    
    // Get headers
    let headers = [];
    table.querySelectorAll("thead th").forEach(th => headers.push(th.innerText));
    rows.push(headers.join(","));

    // Get rows
    table.querySelectorAll("tbody tr").forEach(tr => {
        let rowData = [];
        tr.querySelectorAll("td").forEach(td => rowData.push(td.innerText));
        rows.push(rowData.join(","));
    });

    // Create download link
    const csvContent = "data:text/csv;charset=utf-8," + rows.join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "stockpile_forecast.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- PDF Export Function ---
function exportStockpilePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // Portrait, A4

    // 1. Title & Metadata
    doc.setFontSize(18);
    doc.text("Stockpile Forecast Report", 14, 15);
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);

    // 2. Chart Snapshot
    const canvas = document.getElementById('stockpileChart');
    // Create a white background temporary canvas to ensure the chart isn't transparent/dark on PDF
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = canvas.width;
    tempCanvas.height = canvas.height;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.fillStyle = '#ffffff';
    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
    tempCtx.drawImage(canvas, 0, 0);
    
    const chartImg = tempCanvas.toDataURL('image/png', 1.0);
    doc.addImage(chartImg, 'PNG', 10, 30, 190, 80);

    // 3. Data Table
    doc.autoTable({
        html: '#stockpileTable',
        startY: 120,
        theme: 'grid',
        headStyles: { fillColor: [50, 50, 50], textColor: 255 },
        styles: { fontSize: 9 },
        didParseCell: function(data) {
            // Color code the variance columns (Index 4 and 5)
            if (data.section === 'body' && (data.column.index === 4 || data.column.index === 5)) {
                const val = parseFloat(data.cell.raw.replace('%', ''));
                if (val < 0) {
                    data.cell.styles.textColor = [220, 53, 69]; // Red
                } else {
                    data.cell.styles.textColor = [40, 199, 111]; // Green
                }
            }
        }
    });

    doc.save(`stockpile_report_${new Date().toISOString().slice(0,10)}.pdf`);
}
</script>
{% endblock %}