{% extends 'dashboard/base.html' %}

{% block title %}Mine-Plant Coordination Dashboard{% endblock %}

{% block content %}
<h1>Mine-Plant Coordination Dashboard</h1>
<p>Welcome! Use this dashboard to monitor mine production, plant demand, ore quality, stockpiles, and phase progress.</p>

<div style="display:flex; flex-wrap:wrap; gap:20px;">

    <!-- Production vs Plant Demand -->
    <div style="flex:1 1 45%; background:#f8f9fa; padding:15px; border-radius:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3>Production vs Plant Demand</h3>
        <canvas id="prodDemandChart" width="400" height="250"></canvas>
        <a href="{% url 'production-vs-demand' %}">View Details</a>
    </div>

    <!-- Ore Grade & Tonnage -->
    <div style="flex:1 1 45%; background:#f8f9fa; padding:15px; border-radius:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3>Ore Grade & Tonnage</h3>
        <canvas id="oreGradeTonnageChart" width="400" height="250"></canvas>
        <a href="{% url 'ore-grade-tonnage' %}">View Details</a>
    </div>

    <!-- Stockpile Forecast -->
    <div style="flex:1 1 45%; background:#f8f9fa; padding:15px; border-radius:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3>Stockpile Forecast</h3>
        <canvas id="stockpileChart" width="400" height="250"></canvas>
        <a href="{% url 'stockpile-forecast' %}">View Details</a>
    </div>

    <!-- Phase Progress -->
    <div style="flex:1 1 45%; background:#f8f9fa; padding:15px; border-radius:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3>Phase Progress</h3>
        <canvas id="phaseProgressChart" width="400" height="250"></canvas>
        <a href="{% url 'pit_phase_dashboard' %}">View Details</a>
    </div>

</div>

<!-- Load Chart.js & Luxon -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>

<script>
// Fetch data & render Production vs Demand chart
async function fetchProdDemand() {
    const [prodResp, demandResp] = await Promise.all([
        fetch('/api/production/'),
        fetch('/api/plantdemand/')
    ]);
    const prodData = await prodResp.json();
    const demandData = await demandResp.json();

    const labels = prodData.map(d => new Date(d.timestamp).toLocaleDateString());
    const prodValues = prodData.map(d => d.tonnage);
    const demandValues = demandData.map(d => d.required_tonnage);

    new Chart(document.getElementById('prodDemandChart'), {
        type:'line',
        data: {
            labels: labels,
            datasets: [
                { label:'Production', data:prodValues, borderColor:'blue', fill:false },
                { label:'Plant Demand', data:demandValues, borderColor:'red', fill:false }
            ]
        },
        options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
    });
}

// Fetch Ore Grade & Tonnage chart
async function fetchOreGradeTonnage() {
    const [oreResp, prodResp] = await Promise.all([
        fetch('/api/oresamples/'),
        fetch('/api/production/')
    ]);
    const oreData = await oreResp.json();
    const prodData = await prodResp.json();

    if(!oreData.length) return;

    const phases = [...new Set(oreData.map(i => i.mine_phase.name))];

    const gradeDatasets = phases.map(phase => ({
        label: phase+' Grade',
        data: oreData.filter(i => i.mine_phase.name===phase).map(i=>({x:new Date(i.timestamp), y:i.grade_g_t})),
        type:'line',
        yAxisID:'yGrade',
        borderColor:'#'+Math.floor(Math.random()*16777215).toString(16),
        fill:false,
        tension:0.1
    }));

    const tonnageDataset = {
        label:'Tonnage',
        data:prodData.map(i=>({x:new Date(i.timestamp), y:i.tonnage})),
        type:'bar',
        yAxisID:'yTonnage',
        backgroundColor:'rgba(0,123,255,0.5)'
    };

    new Chart(document.getElementById('oreGradeTonnageChart').getContext('2d'), {
        data: { datasets:[...gradeDatasets, tonnageDataset] },
        options:{
            responsive:true,
            parsing:{xAxisKey:'x',yAxisKey:'y'},
            scales:{
                x:{ type:'time', time:{ unit:'day' }, title:{display:true,text:'Date'} },
                yGrade:{ type:'linear', position:'left', title:{display:true,text:'Grade (g/t)'} },
                yTonnage:{ type:'linear', position:'right', title:{display:true,text:'Tonnage (t)'}, grid:{ drawOnChartArea:false } }
            }
        }
    });
}

// Fetch Stockpile Chart
async function fetchStockpileChart() {
    const resp = await fetch('/api/stockpiles/');
    const data = await resp.json();
    if(!data.length) return;
    const chartData = data.map(i=>({x:i.timestamp,y:i.current_tonnage}));
    new Chart(document.getElementById('stockpileChart').getContext('2d'), {
        type:'line',
        data:{ datasets:[{label:'Stockpile', data:chartData, borderColor:'green', fill:true, tension:0.2}] },
        options:{ parsing:{xAxisKey:'x',yAxisKey:'y'}, scales:{ x:{type:'time', time:{unit:'day'}}, y:{beginAtZero:true} } }
    });
}

// Fetch Phase Progress
async function fetchPhaseProgress() {
    const resp = await fetch('/api/phaseschedule/');
    const data = await resp.json();
    if(!data.length) return;

    const labels = data.map(i=>i.mine_phase.name);
    const completion = data.map(i=>i.current_progress||0);
    const planned = data.map(()=>100);

    new Chart(document.getElementById('phaseProgressChart').getContext('2d'), {
        type:'bar',
        data:{
            labels:labels,
            datasets:[
                { label:'Completed (%)', data:completion, backgroundColor:completion.map(p=>p<100?'red':'green') },
                { label:'Planned (%)', data:planned, backgroundColor:'rgba(200,200,200,0.3)' }
            ]
        },
        options:{ indexAxis:'y', responsive:true, scales:{ x:{ max:100 }, y:{ } } }
    });
}

// Load all charts
fetchProdDemand();
fetchOreGradeTonnage();
fetchStockpileChart();
fetchPhaseProgress();
</script>

{% endblock %}
