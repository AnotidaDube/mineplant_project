document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('lossChart').getContext('2d');
    let chart = null;

    function fetchAndRender() {
        const spinner = document.getElementById('loadingSpinner');
        spinner.style.display = 'block';

        const period = document.getElementById('periodSelect').value;
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;

        const params = new URLSearchParams({ period });
        if (start) params.set('start', start);
        if (end) params.set('end', end);

        fetch(`/processing/loss/data/?${params.toString()}`)
            .then(response => {
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                return response.json();
            })
            .then(data => {
                spinner.style.display = 'none';

                if (data.message) {
                    alert(data.message);
                    return;
                }

                if (!Array.isArray(data.labels) || data.labels.length === 0) {
                    alert('No data available.');
                    return;
                }

                if (chart) chart.destroy();

                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Gold Lost (kg)',
                                data: data.gold,
                                backgroundColor: 'rgba(255, 215, 0, 0.6)',
                                borderColor: 'rgba(255, 215, 0, 1)',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Revenue Lost (USD)',
                                data: data.revenue,
                                type: 'line',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.3)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                type: 'linear',
                                position: 'left',
                                title: { display: true, text: 'Gold Lost (kg)' }
                            },
                            y1: {
                                type: 'linear',
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                title: { display: true, text: 'Revenue Lost (USD)' }
                            }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Gold & Revenue Loss Analysis' }
                        }
                    }
                });
            })
            .catch(err => {
                spinner.style.display = 'none';
                console.error('Fetch error:', err);
                alert('Failed to load data. Please try again.');
            });
    }

    // Event listeners
    document.getElementById('periodSelect').addEventListener('change', fetchAndRender);
    document.getElementById('startDate').addEventListener('change', fetchAndRender);
    document.getElementById('endDate').addEventListener('change', fetchAndRender);

    // Initial render
    fetchAndRender();

    // ✅ Export chart to PDF with metadata
document.getElementById('exportPdfBtn').addEventListener('click', function () {
    const period = document.getElementById('periodSelect').value;
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;

    html2canvas(document.getElementById('lossChart')).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;   // ✅ use global object
        const pdf = new jsPDF();

        pdf.setFontSize(12);
        pdf.text('Gold & Revenue Loss Analysis', 10, 10);
        pdf.text(`Period: ${period.charAt(0).toUpperCase() + period.slice(1)}`, 10, 18);
        pdf.text(`Start Date: ${start || 'Not selected'}`, 10, 26);
        pdf.text(`End Date: ${end || 'Not selected'}`, 10, 34);

        pdf.addImage(imgData, 'PNG', 10, 45, 180, 100);

        pdf.setFontSize(10);
        pdf.text('© 2025 Mine-Plant Coordination Dashboard | Generated by Zviko', 10, 160);

        pdf.save(`loss_analysis_${period}_${start || 'start'}_${end || 'end'}.pdf`);
    });
});
        });
   

